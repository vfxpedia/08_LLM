# RAG 검색 전략

## 개요

ZIPFIT의 RAG(Retrieval-Augmented Generation) 시스템은 **이중 데이터베이스 전략**을 사용합니다. RDB(관계형 데이터베이스)로 빠르게 필터링하고, Vector DB로 의미론적 검색을 수행하여 정확하고 빠른 응답을 제공합니다.

---

## 1. 이중 데이터베이스 전략

### 1.1 전략 개요

```
사용자 질문
    ↓
[1단계] RDB 빠른 필터링
    - 지역, 유형, 상태, 날짜 등 메타데이터 필터링
    - SQL 쿼리로 빠른 검색
    - 결과: 관련 공고 ID 목록
    ↓
[2단계] Vector DB 의미론적 검색 (필요시)
    - 필터링된 공고의 문서 내용 검색
    - 임베딩 기반 유사도 검색
    - 결과: 관련 문서 청크
    ↓
[3단계] LLM 답변 생성
    - 검색된 정보 기반 답변
    - 출처 명시
```

### 1.2 왜 이중 전략인가?

**RDB만 사용 시 문제**
- 메타데이터 기반 검색만 가능
- 문서 내용의 의미론적 검색 불가
- "보증금이 저렴한 공고" 같은 질문 처리 어려움

**Vector DB만 사용 시 문제**
- 모든 공고 문서 검색 시 응답 느림
- 간단한 필터링(지역, 날짜)에도 임베딩 검색 필요
- 비효율적

**이중 전략의 장점**
- ✓ RDB로 빠른 1차 필터링
- ✓ Vector DB로 정확한 의미 검색
- ✓ 응답 속도 최적화
- ✓ 검색 정확도 향상

---

## 2. RDB 검색 (1단계)

### 2.1 RDB 스키마 (메타데이터)

```sql
CREATE TABLE announcements (
    id VARCHAR(50) PRIMARY KEY,          -- LH_lease_1
    provider VARCHAR(10) NOT NULL,       -- LH, SH, GH
    announcement_type VARCHAR(50),       -- 행복주택, 국민임대 등
    title TEXT NOT NULL,
    region VARCHAR(100),                 -- 서울특별시 마포구
    district VARCHAR(50),                -- 마포구

    deposit INTEGER,                     -- 보증금
    monthly_rent INTEGER,                -- 월세

    application_start DATE,              -- 신청 시작일
    application_end DATE,                -- 신청 마감일
    status VARCHAR(20),                  -- 접수중, 접수마감, 예정

    move_in_date DATE,                   -- 입주 예정일
    total_units INTEGER,                 -- 총 공급 세대수

    view_count INTEGER,                  -- 조회수
    url TEXT,                            -- 공고 URL

    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX idx_region ON announcements(region);
CREATE INDEX idx_status ON announcements(status);
CREATE INDEX idx_application_end ON announcements(application_end);
```

### 2.2 RDB 검색 시나리오

**시나리오 1: 지역 필터링**
```sql
-- 사용자: "마포구 공고 보여줘"

SELECT id, title, deposit, monthly_rent
FROM announcements
WHERE region LIKE '%마포구%'
  AND status = '접수중'
ORDER BY application_end ASC;
```

**시나리오 2: 보증금 범위**
```sql
-- 사용자: "보증금 1000만원 이하 공고"

SELECT id, title, deposit, monthly_rent, region
FROM announcements
WHERE deposit <= 10000000
  AND status = '접수중'
ORDER BY deposit ASC;
```

**시나리오 3: 마감 임박**
```sql
-- 사용자: "마감 임박 공고"

SELECT id, title, application_end, region
FROM announcements
WHERE status = '접수중'
  AND application_end BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days'
ORDER BY application_end ASC;
```

**시나리오 4: 복합 필터링**
```sql
-- 사용자: "서울에서 월세 20만원 이하, 3개월 내 입주 가능한 공고"

SELECT id, title, region, monthly_rent, move_in_date
FROM announcements
WHERE region LIKE '서울%'
  AND monthly_rent <= 200000
  AND move_in_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '3 months'
  AND status = '접수중'
ORDER BY monthly_rent ASC;
```

### 2.3 RDB 검색 결과

**결과 형식**
```python
# RDB 검색 결과
announcements = [
    {
        "id": "LH_lease_1",
        "title": "마포구 공덕동 행복주택",
        "deposit": 12000000,
        "monthly_rent": 220000,
        "region": "서울특별시 마포구",
        "application_end": "2024-11-25"
    },
    {
        "id": "LH_lease_2",
        "title": "성동구 행당동 행복주택",
        "deposit": 10000000,
        "monthly_rent": 190000,
        "region": "서울특별시 성동구",
        "application_end": "2024-11-28"
    }
]
```

**RDB 검색만으로 충분한 경우**
- 공고 목록 조회
- 간단한 정보 확인 (보증금, 월세, 지역)
- 마감일 확인

**Vector DB 검색이 필요한 경우**
- 자격 조건 상세 확인
- 신청 절차 질문
- 특정 조건 찾기 (예: "주차장 정보")

---

## 3. Vector DB 검색 (2단계)

### 3.1 Vector DB 스키마

```sql
CREATE TABLE announcement_embeddings (
    id SERIAL PRIMARY KEY,
    announcement_id VARCHAR(50) REFERENCES announcements(id),

    chunk_text TEXT NOT NULL,            -- 문서 청크 내용
    chunk_index INTEGER,                 -- 청크 순서
    page_number INTEGER,                 -- PDF 페이지 번호
    section_type VARCHAR(50),            -- 자격조건, 신청방법, 기타

    embedding vector(768),               -- 임베딩 벡터

    created_at TIMESTAMP
);

CREATE INDEX ON announcement_embeddings USING ivfflat (embedding vector_cosine_ops);
```

### 3.2 문서 청크 전략

**청크 크기**
- 기본: 500 토큰 (약 300-400단어)
- 오버랩: 50 토큰

**청크 구분 기준**
- 섹션별 구분 (자격 조건, 신청 방법, 공급 내용 등)
- 페이지별 구분
- 의미 단위 유지

**예시 청크**
```
[청크 1 - 자격 조건]
"제3조(입주자 자격)
① 입주자로 선정되려는 자는 다음 각 호의 요건을 모두 충족하여야 한다.
1. 만 19세 이상 만 39세 이하인 자
2. 무주택세대구성원
3. 해당 세대의 월평균소득이 전년도 도시근로자 가구당 월평균소득의 120% 이하인 자"
(페이지: 3, 섹션: 자격조건)

[청크 2 - 공급 내용]
"마포구 공덕동 행복주택 공급 개요
- 공급 위치: 서울특별시 마포구 공덕동 123-45
- 공급 세대수: 120세대
- 주택 형별: 전용면적 26㎡(80세대), 36㎡(40세대)"
(페이지: 5, 섹션: 공급내용)
```

### 3.3 Vector DB 검색 프로세스

**1. 사용자 질문 임베딩**
```python
user_query = "자격 조건이 어떻게 돼?"
query_embedding = embed_text(user_query)  # 768차원 벡터
```

**2. 유사도 검색**
```sql
-- RDB에서 필터링된 공고 ID로 제한
SELECT
    ae.announcement_id,
    ae.chunk_text,
    ae.page_number,
    ae.section_type,
    1 - (ae.embedding <=> query_embedding::vector) AS similarity
FROM announcement_embeddings ae
WHERE ae.announcement_id IN ('LH_lease_1', 'LH_lease_2')  -- RDB 필터링 결과
ORDER BY ae.embedding <=> query_embedding::vector
LIMIT 5;
```

**3. 검색 결과**
```python
search_results = [
    {
        "announcement_id": "LH_lease_1",
        "chunk_text": "제3조(입주자 자격) ① 입주자로 선정되려는 자는...",
        "page_number": 3,
        "section_type": "자격조건",
        "similarity": 0.92
    },
    {
        "announcement_id": "LH_lease_1",
        "chunk_text": "청년 자격: 만 19세 이상 만 39세 이하...",
        "page_number": 3,
        "section_type": "자격조건",
        "similarity": 0.89
    }
]
```

### 3.4 유사도 임계값

**임계값 설정**
- High relevance: 0.8 이상
- Medium relevance: 0.6 ~ 0.8
- Low relevance: 0.6 이하 (제외)

**임계값 미달 시**
```
지피: 죄송하지만, 해당 공고문에서 관련 정보를 찾지 못했습니다.
LH 상담센터(1600-1004)로 문의하시면 정확한 답변을 받으실 수 있습니다.
```

---

## 4. 질문 유형별 검색 전략

### 4.1 메타데이터 질문 → RDB만

**질문 예시**
- "마포구 공고 보여줘"
- "월세 20만원 이하 공고"
- "마감 임박 공고"
- "보증금이 얼마야?"

**검색 전략**
1. RDB만 사용
2. 빠른 응답
3. Vector DB 불필요

**예시**
```
사용자: 마포구 공고 보여줘

[검색 과정]
1. RDB 쿼리: region LIKE '%마포구%' AND status = '접수중'
2. 결과 반환 (Vector DB 사용 안 함)

지피: 현재 마포구 모집 중인 공고 2건입니다.

1. 마포구 공덕동 행복주택
   - 보증금/월세: 1,200만원 / 22만원
   - 마감: 2024.11.25

2. 마포구 상암동 행복주택
   - 보증금/월세: 1,100만원 / 20만원
   - 마감: 2024.12.01
```

### 4.2 문서 내용 질문 → RDB + Vector DB

**질문 예시**
- "자격 조건이 어떻게 돼?"
- "신청 방법 알려줘"
- "필요한 서류가 뭐야?"
- "주차장 정보 있어?"

**검색 전략**
1. RDB로 공고 필터링 (사용자 지역/조건 기반)
2. Vector DB로 문서 내용 검색
3. 관련 청크 추출

**예시**
```
사용자: 자격 조건이 어떻게 돼?

[검색 과정]
1. RDB: 사용자 프로필(마포구) 기반 공고 필터링
   → 결과: LH_lease_1 (마포구 공덕동)

2. Vector DB: "자격 조건" 관련 청크 검색
   → Query embedding: embed("자격 조건이 어떻게 돼?")
   → 유사도 검색: announcement_id = 'LH_lease_1'
   → 결과: 자격 조건 섹션 (p.3)

지피: 마포구 공덕동 행복주택 자격 조건입니다.

- 연령: 만 19~39세
- 무주택 요건
- 소득: 도시근로자 월평균소득 120% 이하

(출처: LH_마포공덕_행복주택.pdf p.3)
```

### 4.3 비교 질문 → RDB + Vector DB

**질문 예시**
- "마포 vs 성동 비교해줘"
- "어느 게 더 저렴해?"
- "입주가 빠른 곳은?"

**검색 전략**
1. RDB로 비교 대상 공고 필터링
2. Vector DB로 각 공고 상세 정보 검색
3. 비교표 생성

**예시**
```
사용자: 마포 vs 성동 비교해줘

[검색 과정]
1. RDB: 마포구, 성동구 공고 검색
   → 결과: LH_lease_1 (마포), LH_lease_2 (성동)

2. Vector DB: 각 공고의 상세 정보 검색
   → 보증금/월세, 교통, 입주일 등

지피: 두 공고를 비교해드리겠습니다.

마포 공덕:
- 보증금/월세: 1,200만원 / 22만원
- 교통: 지하철 5,6호선 도보 5분
- 입주: 2025년 3월

성동 행당:
- 보증금/월세: 1,000만원 / 19만원
- 교통: 지하철 2,5호선 도보 10분
- 입주: 2025년 5월

(출처: 각 공고문)
```

---

## 5. 대규모 공고 처리

### 5.1 30개 이상 세대 공고

**문제**
- 한 공고에 30개 이상 세대 (예: 26㎡ 10개, 36㎡ 15개, 46㎡ 5개)
- 모든 정보 한 번에 제공 시 혼란

**해결 전략**
1. RDB로 사용자 조건 기반 필터링
2. 대화형으로 조건 좁히기
3. 최종 3개 이하로 제시

**예시**
```
사용자: 이 공고에 어떤 집들이 있어?

지피: 마포구 공덕동 행복주택은 총 120세대입니다.

세대 유형:
- 26㎡: 80세대 (청년 우선)
- 36㎡: 30세대 (신혼부부 우선)
- 46㎡: 10세대 (일반 공급)

희망하시는 면적이 있으신가요?

사용자: 26㎡

지피: 26㎡ 청년 우선 공급 상세 정보입니다.

- 공급 세대: 80세대
- 보증금/월세: 1,200만원 / 22만원
- 자격: 만 19~39세 청년
- 신청 마감: 2024.11.25

(출처: LH_마포공덕_행복주택.pdf p.5)

자격 조건을 확인해드릴까요?
```

---

## 6. 검색 최적화

### 6.1 캐싱 전략

**자주 묻는 질문 (FAQ) 캐싱**
- "자격 조건이 뭐야?"
- "신청 방법 알려줘"
- "보증금이 얼마야?"

**공고별 캐싱**
```python
cache_key = f"{announcement_id}:{question_type}"
# 예: "LH_lease_1:자격조건"

if cache_key in cache:
    return cache[cache_key]
else:
    result = search_vector_db(announcement_id, query)
    cache[cache_key] = result
    return result
```

### 6.2 검색 결과 제한

**최대 검색 결과 수**
- Vector DB 검색: 최대 5개 청크
- 관련도 높은 순으로 정렬
- 임계값(0.6) 이하 제외

### 6.3 응답 시간 목표

**목표 응답 시간**
- RDB만: 0.5초 이하
- RDB + Vector DB: 2초 이하

**지연 시**
```
지피: 잠시만 기다려주세요. 공고문을 검색 중입니다...

(검색 중...)

지피: 자격 조건 정보입니다...
```

---

## 7. 검색 실패 처리

### 7.1 RDB 검색 결과 없음

```
사용자: 인천 공고 보여줘

[RDB 검색]
SELECT * FROM announcements WHERE region LIKE '%인천%'
→ 결과: 0건

지피: 죄송합니다. 현재 인천 지역에는 모집 중인 공고가 없습니다.

가까운 지역:
- 서울 강서구 (인천 경계 인접)
- 경기 부천시

공고 알림을 설정하시겠습니까?
```

### 7.2 Vector DB 검색 실패

```
사용자: 주차장은 몇 대야?

[Vector DB 검색]
Query: "주차장"
→ 유사도: 0.45 (임계값 0.6 미만)
→ 검색 실패

지피: 죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다.

더 자세한 정보는 LH 상담센터(1600-1004)로 문의하시면
정확한 답변을 받으실 수 있습니다.
```

---

## 8. 검색 전략 체크리스트

모든 검색 시:

**1단계: RDB 검색**
- [ ] 사용자 조건 파악 (지역, 가격, 날짜 등)
- [ ] SQL 쿼리 생성
- [ ] 필터링된 공고 ID 목록 확인

**2단계: Vector DB 필요성 판단**
- [ ] 메타데이터만으로 답변 가능한가?
- [ ] 문서 내용 검색이 필요한가?
- [ ] 여러 공고 비교가 필요한가?

**3단계: Vector DB 검색 (필요시)**
- [ ] RDB 필터링 결과로 검색 범위 제한
- [ ] 유사도 임계값 확인 (0.6 이상)
- [ ] 관련 청크 추출

**4단계: 결과 검증**
- [ ] 검색 결과가 질문과 관련 있는가?
- [ ] 출처를 명시할 수 있는가?
- [ ] 정확한 정보인가?

---

## 관련 문서

- [02_문서_참조_방식.md](./02_문서_참조_방식.md)
- [03_할루시네이션_방지.md](./03_할루시네이션_방지.md)
- [../01_core_principles.md](../01_core_principles.md)
- [../../database/05_데이터베이스_설계.md](../../database/05_데이터베이스_설계.md)

---

**작성일**: 2025년 11월 21일

**작성자**: 오흥재

**버전**: v1.0.0
