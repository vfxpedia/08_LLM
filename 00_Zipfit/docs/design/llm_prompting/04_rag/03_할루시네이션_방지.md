# 할루시네이션 방지 (Hallucination Prevention)

## 개요

할루시네이션(Hallucination)은 LLM이 문서에 없는 정보를 만들어내는 현상입니다. ZIPFIT에서는 **정확성이 최우선**이므로, 할루시네이션을 절대 허용하지 않습니다.

**핵심 원칙**
> "틀린 정보를 제공하는 것은 정보를 제공하지 않는 것보다 나쁩니다."

---

## 1. 할루시네이션이란?

### 1.1 정의

**할루시네이션 (Hallucination)**
- LLM이 문서에 없는 정보를 생성하는 현상
- 사실처럼 보이지만 근거 없는 정보
- 추측, 일반화, 임의 생성 포함

### 1.2 ZIPFIT에서의 할루시네이션 예시

**예시 1: 수치 추측**
```
[문서]
"보증금: 명시 안 됨"

[할루시네이션 - 금지]
사용자: 보증금이 얼마야?
지피: 보통 1000~1500만원 정도입니다.
(X - 추측)

[올바른 답변]
사용자: 보증금이 얼마야?
지피: 죄송하지만, 해당 공고문에서 보증금 정보를 확인할 수 없습니다.
LH 상담센터(1600-1004)로 문의하시면 정확한 정보를 받으실 수 있습니다.
```

**예시 2: 링크 생성**
```
[할루시네이션 - 금지]
사용자: 신청 링크 알려줘
지피: https://apply.lh.or.kr/notice/123456 에서 신청하시면 됩니다.
(X - 확인되지 않은 링크)

[올바른 답변]
사용자: 신청 링크 알려줘
지피: LH 청약센터 공식 웹사이트는 apply.lh.or.kr 입니다.
(출처: LH_마포공덕_행복주택.pdf p.8)

해당 사이트에서 공고를 검색하여 신청하실 수 있습니다.
```

**예시 3: 조건 추가**
```
[문서]
"자격: 만 19~39세, 무주택"

[할루시네이션 - 금지]
사용자: 자격 조건이 뭐야?
지피: 만 19~39세, 무주택이면서, 서울 거주 1년 이상이어야 합니다.
(X - "서울 거주 1년" 추가됨)

[올바른 답변]
사용자: 자격 조건이 뭐야?
지피: 자격 조건은 다음과 같습니다.
- 연령: 만 19~39세
- 무주택 요건

(출처: LH_마포공덕_행복주택.pdf p.3)
```

---

## 2. 할루시네이션 발생 시나리오

### 2.1 정보 부족

**시나리오**
- 사용자가 질문했지만 문서에 해당 정보 없음
- LLM이 일반 상식으로 답변하려는 유혹

**예시**
```
사용자: 주차장은 몇 대야?

[문서]
"주차장 정보: 없음"

[할루시네이션 위험]
"보통 세대당 0.8대 정도입니다"

[올바른 처리]
죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다.
```

### 2.2 애매한 표현

**시나리오**
- 문서에 모호한 표현
- LLM이 구체화하려고 시도

**예시**
```
[문서]
"입주 예정: 2025년 상반기"

[할루시네이션 위험]
"입주는 2025년 3월입니다"

[올바른 처리]
입주 예정은 2025년 상반기입니다.
(출처: LH_마포공덕_행복주택.pdf p.1)

구체적인 입주일은 LH 상담센터(1600-1004)로 확인하시길 권장합니다.
```

### 2.3 여러 문서 혼동

**시나리오**
- 여러 공고 비교 시
- A 공고 정보를 B 공고에 적용

**예시**
```
[마포 공고]
"보증금: 1,200만원"

[성동 공고]
"보증금: 명시 안 됨"

[할루시네이션 위험]
성동 공고도 1,200만원 정도일 것입니다.

[올바른 처리]
마포: 1,200만원 (출처: LH_마포공덕_행복주택.pdf p.5)
성동: 공고문에서 확인 불가

성동 보증금은 LH 상담센터로 문의하시기 바랍니다.
```

### 2.4 과거 대화 혼동

**시나리오**
- 이전 대화에서 다른 공고 이야기
- 현재 질문에 이전 정보 적용

**예시**
```
[이전 대화]
사용자: 마포 공고 보증금?
지피: 1,200만원입니다.

[현재 대화]
사용자: 보증금 얼마야? (성동 공고 보는 중)

[할루시네이션 위험]
1,200만원입니다. (이전 대화 정보)

[올바른 처리]
성동구 행당동 행복주택 보증금은 1,000만원입니다.
(출처: LH_성동행당_행복주택.pdf p.5)
```

---

## 3. 할루시네이션 방지 전략

### 3.1 Grounding (근거 기반)

**원칙**
- 모든 답변은 문서 검색 결과 기반
- RAG 검색 없이 답변하지 않음
- 검색 결과 없으면 "확인 불가" 응답

**프로세스**
```
사용자 질문
    ↓
[1] RAG 검색 수행
    ↓
[2] 검색 결과 있는가?
    - Yes → 문서 기반 답변
    - No → "확인 불가" + 대안 제시
    ↓
[3] 출처 명시
```

**예시**
```python
def generate_answer(user_query):
    # 1. RAG 검색
    search_results = rag_search(user_query)

    # 2. 검색 결과 확인
    if not search_results or search_results[0]['similarity'] < 0.6:
        return "죄송하지만, 해당 정보를 확인할 수 없습니다. LH 상담센터(1600-1004)로 문의하시기 바랍니다."

    # 3. 문서 기반 답변
    answer = generate_from_chunks(search_results)
    source = f"(출처: {search_results[0]['document']} p.{search_results[0]['page']})"

    return f"{answer}\n\n{source}"
```

### 3.2 Verification (검증)

**원칙**
- 생성된 답변을 검색 결과와 재확인
- 수치, 날짜, 조건 정확성 검증
- 출처 페이지 번호 검증

**체크리스트**
```
답변 생성 후:
- [ ] 검색된 청크에 해당 정보가 있는가?
- [ ] 수치가 정확한가? (1,200만원 vs 1,000만원)
- [ ] 날짜가 정확한가? (2024.11.25 vs 2024.12.25)
- [ ] 조건이 누락되지 않았는가? (3가지 조건 → 3가지 모두 언급)
- [ ] 페이지 번호가 맞는가?
```

**예시**
```python
def verify_answer(answer, search_results):
    # 답변의 수치 추출
    numbers_in_answer = extract_numbers(answer)

    # 검색 결과의 수치 추출
    numbers_in_chunks = extract_numbers(search_results[0]['chunk_text'])

    # 일치 여부 확인
    if numbers_in_answer != numbers_in_chunks:
        raise HallucinationError("수치 불일치 감지")

    return True
```

### 3.3 Uncertainty Expression (불확실성 표현)

**원칙**
- 불확실하면 명시
- "아마도", "보통" 같은 추측 표현 금지
- "확인이 필요합니다" 명확히 표현

**불확실성 레벨**
```
[레벨 1] 정보 없음
→ "죄송하지만, 해당 정보를 확인할 수 없습니다."

[레벨 2] 부분 정보
→ "공고문에는 [일부 정보]만 명시되어 있습니다. 구체적인 정보는 상담센터로 문의하시기 바랍니다."

[레벨 3] 모호한 정보
→ "공고문에는 [모호한 표현]으로 명시되어 있습니다. 정확한 확인은 상담센터로 문의하시기 바랍니다."
```

**예시**
```
[레벨 1 - 정보 없음]
사용자: 주차장 몇 대야?

지피: 죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다.
LH 상담센터(1600-1004)로 문의하시면 정확한 답변을 받으실 수 있습니다.

[레벨 2 - 부분 정보]
사용자: 주차장 정보 알려줘

지피: 공고문에는 "지상 주차장 운영"이라고만 명시되어 있습니다.
구체적인 주차 대수는 LH 상담센터(1600-1004)로 문의하시기 바랍니다.
(출처: LH_마포공덕_행복주택.pdf p.10)

[레벨 3 - 모호한 정보]
사용자: 입주일이 정확히 언제야?

지피: 공고문에는 "2025년 상반기 예정"으로 명시되어 있습니다.
정확한 입주일은 LH 상담센터(1600-1004)로 확인하시길 권장합니다.
(출처: LH_마포공덕_행복주택.pdf p.1)
```

---

## 4. 금지 표현 목록

### 4.1 추측 표현

**절대 사용 금지**
- ✗ "아마도"
- ✗ "보통"
- ✗ "대략"
- ✗ "~일 것 같습니다"
- ✗ "~인 것 같아요"
- ✗ "추정하건대"
- ✗ "예상하면"

### 4.2 일반화 표현

**절대 사용 금지**
- ✗ "일반적으로"
- ✗ "대부분"
- ✗ "많은 경우"
- ✗ "보통은"
- ✗ "평균적으로"

### 4.3 범위 표현

**절대 사용 금지**
- ✗ "1000~1500만원 정도"
- ✗ "20만원 전후"
- ✗ "약 3개월"

**허용 (문서 명시 시)**
- ✓ "1,200만원" (정확한 수치)
- ✓ "2024.11.25" (정확한 날짜)
- ✓ "2025년 3월" (문서 원문)

---

## 5. 할루시네이션 탐지

### 5.1 자동 탐지 메커니즘

**검색 유사도 확인**
```python
def detect_hallucination_by_similarity(search_results):
    if not search_results:
        return True  # 검색 결과 없음 = 할루시네이션 위험

    max_similarity = max([r['similarity'] for r in search_results])

    if max_similarity < 0.6:
        return True  # 유사도 낮음 = 할루시네이션 위험

    return False
```

**수치 불일치 확인**
```python
def detect_number_mismatch(answer, source_chunk):
    answer_numbers = extract_numbers(answer)
    source_numbers = extract_numbers(source_chunk)

    # 수치가 정확히 일치하는지 확인
    for num in answer_numbers:
        if num not in source_numbers:
            return True  # 불일치 = 할루시네이션

    return False
```

**출처 검증**
```python
def verify_source_exists(source_citation):
    # 출처 형식: (출처: LH_마포공덕_행복주택.pdf p.5)

    # 문서 존재 여부
    if not document_exists(source_citation['document']):
        return False

    # 페이지 존재 여부
    if not page_exists(source_citation['document'], source_citation['page']):
        return False

    return True
```

### 5.2 수동 검증 체크리스트

**답변 생성 후 확인**
```
[ ] 검색 결과가 있는가?
[ ] 유사도가 0.6 이상인가?
[ ] 수치가 정확한가?
[ ] 날짜가 정확한가?
[ ] 조건이 누락되지 않았는가?
[ ] 출처가 명시되었는가?
[ ] 페이지 번호가 정확한가?
[ ] 추측 표현이 없는가?
[ ] 문서에 없는 정보가 포함되지 않았는가?
```

---

## 6. 할루시네이션 발생 시 대응

### 6.1 즉시 답변 중단

```python
def generate_answer_safe(user_query):
    try:
        # RAG 검색
        search_results = rag_search(user_query)

        # 할루시네이션 탐지
        if detect_hallucination(search_results):
            return fallback_response()

        # 답변 생성
        answer = generate_from_chunks(search_results)

        # 검증
        if not verify_answer(answer, search_results):
            return fallback_response()

        return answer

    except Exception as e:
        # 오류 발생 시 안전한 답변
        return fallback_response()

def fallback_response():
    return """
죄송합니다. 정확한 정보를 찾지 못했습니다.
LH 상담센터(1600-1004)로 문의하시면 정확한 답변을 받으실 수 있습니다.
"""
```

### 6.2 사용자 고지

```
지피: 죄송합니다. 정확한 정보를 찾지 못했습니다.

해당 정보는 LH 상담센터(1600-1004)로 문의하시면
정확한 답변을 받으실 수 있습니다.

공고문에 명시된 다른 정보가 필요하신가요?
```

### 6.3 대안 제시

```
지피: 죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다.

[대안 1] LH 상담센터(1600-1004)로 문의
[대안 2] LH 청약센터(apply.lh.or.kr)에서 공고 상세 확인
[대안 3] 현장 방문하여 확인

공고문에 명시된 다른 정보를 안내해드릴까요?
```

---

## 7. 테스트 케이스

### 7.1 할루시네이션 유발 질문

**테스트 목적**
- 할루시네이션 방지 메커니즘 검증
- 시스템이 올바르게 "확인 불가" 응답하는지 확인

**테스트 케이스**
```
[TC-1] 문서에 없는 정보
질문: "주차장은 몇 대야?"
문서: 주차 정보 없음
기대 응답: "죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다..."

[TC-2] 애매한 정보
질문: "입주일이 정확히 언제야?"
문서: "2025년 상반기"
기대 응답: "공고문에는 2025년 상반기 예정으로 명시되어 있습니다. 정확한 입주일은 LH 상담센터로..."

[TC-3] 숫자 추측 유발
질문: "보증금 대략 얼마야?"
문서: 보증금 정보 없음
기대 응답: "죄송하지만, 해당 공고문에서 보증금 정보를 확인할 수 없습니다..."

[TC-4] 링크 요청
질문: "신청 링크 보내줘"
문서: URL 없음
기대 응답: "LH 청약센터 공식 웹사이트는 apply.lh.or.kr입니다..." (검증된 공식 사이트만)

[TC-5] 다른 공고 정보 혼동
질문: "성동 공고 보증금은?"
이전 대화: 마포 공고 (1,200만원)
기대 응답: "성동구 행당동 행복주택 보증금은 1,000만원입니다. (출처: LH_성동행당_행복주택.pdf p.5)"
```

### 7.2 통과 기준

**할루시네이션 방지 테스트 통과 기준**
- 문서에 없는 정보 질문 시: "확인 불가" 응답 100%
- 수치 정보: 정확도 100% (추정치 0%)
- 출처 명시: 100% (출처 없는 답변 0%)
- 추측 표현: 0% (모든 답변에서 추측 표현 없음)

---

## 8. 할루시네이션 방지 체크리스트

모든 답변 생성 시:

**검색 단계**
- [ ] RAG 검색을 수행했는가?
- [ ] 검색 결과가 있는가?
- [ ] 유사도가 0.6 이상인가?

**생성 단계**
- [ ] 검색된 청크 기반으로 답변했는가?
- [ ] 추측 표현을 사용하지 않았는가?
- [ ] 일반화 표현을 사용하지 않았는가?

**검증 단계**
- [ ] 수치가 정확한가?
- [ ] 날짜가 정확한가?
- [ ] 조건이 누락되지 않았는가?
- [ ] 문서에 없는 정보가 포함되지 않았는가?

**출처 단계**
- [ ] 출처를 명시했는가?
- [ ] 페이지 번호가 정확한가?
- [ ] 문서명이 정확한가?

**불확실성 처리**
- [ ] 정보 없으면 "확인 불가" 응답했는가?
- [ ] 대안(상담센터)을 제시했는가?

---

## 9. 예시

### 예시 1: 올바른 처리

```
사용자: 주차장은 몇 대야?

[RAG 검색]
→ 유사도: 0.45 (임계값 0.6 미만)
→ 관련 정보 없음

[할루시네이션 방지]
지피: 죄송하지만, 해당 공고문에서 주차 대수 정보를 확인할 수 없습니다.

더 자세한 정보는 LH 상담센터(1600-1004)로 문의하시면
정확한 답변을 받으실 수 있습니다.

공고문에 명시된 다른 정보가 필요하신가요?
```

### 예시 2: 잘못된 처리 (금지)

```
사용자: 주차장은 몇 대야?

[할루시네이션 - 금지]
지피: 보통 세대당 0.8대 정도 배정됩니다.
이 공고도 약 100대 정도일 것 같습니다.
(X - 추측 및 할루시네이션)
```

---

## 관련 문서

- [../01_core_principles.md](../01_core_principles.md)
- [01_검색_전략.md](./01_검색_전략.md)
- [02_문서_참조_방식.md](./02_문서_참조_방식.md)
- [../../05_tests/03_할루시네이션_테스트.md](../../05_tests/03_할루시네이션_테스트.md)

---

**작성일**: 2025년 11월 21일

**작성자**: 오흥재

**버전**: v1.0.0
